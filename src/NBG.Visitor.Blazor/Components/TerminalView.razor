@using MudBlazor;
@using NBG.Visitor.Blazor.Components.Dialogs
@using NBG.Visitor.Blazor.Components.TerminalSubComponents
@using NBG.Visitor.Domain.Dtos;
@using NBG.Visitor.Domain;
@using System.Reflection
@using PdfSharp.Pdf
@using QRCoder
@using System.Drawing
@using System.Net

@inject IDialogService Dialog;
@inject IVisitService vs;

<link href="_content/NBG.Visitor.Blazor/css/site.css" rel="stylesheet"/>

<MudThemeProvider Theme="NBG"/>

<CustomMudCarousel Style=@Style @ref="carousel" AutoCycle="false" ShowArrows="false" ShowDelimiters="false" Swipe="false" TData="object">
    @if (!HideFirstPage)
    {
        <MudCarouselItem>
            <TerminalHome OnNext=@(() => carousel.Next()) />
        </MudCarouselItem>
    }
    <MudCarouselItem>
        <TerminalRegister @ref="form" OnBack=@(HideFirstPage ? null : carousel.Previous) OnNext=carousel.Next />
    </MudCarouselItem>
    <MudCarouselItem>
        <TerminalSafety OnBack=@(() => carousel.Previous()) OnRegister=Register/>
    </MudCarouselItem>
</CustomMudCarousel>

@code {
    [CascadingParameter]
    public Localizer Loc { get; set; }

    [Parameter]
    public string Style { get; set; }

    [Parameter]
    public string QRUrl { get; set; } = "https://fiss.dev.nbg.tech:44303/terminal/";

    [Parameter]
    public bool HideFirstPage { get; set; } = false;

    [Parameter]
    public Guid? PreregisteredVisitGuid { get; set; } = null;

    private MudCarousel<object> carousel;
    private TerminalRegister form;

    MudTheme NBG = new MudTheme()
    {
        Palette = new Palette()
        {
            Primary = Colors.Red.Darken1,
            Secondary = Colors.Grey.Lighten2,
            SecondaryContrastText = Colors.Grey.Darken2
        }
    };

    protected override void OnAfterRender(bool firstRender)
    {
        if (firstRender)
        {
            if (PreregisteredVisitGuid != null)
            {
                Task.Run(() =>
                {
                    while (form == null) { }
                    UseGuid(PreregisteredVisitGuid ?? default(Guid));
                });
            }
        }
    }

    /// <summary>
    /// Loads the visit with the specified guid and fills
    /// the form with the information if the visit is pending or
    /// marks the visit as over if the visit is already active.
    /// </summary>
    /// <param name="guid"></param>
    public async Task UseGuid(Guid guid)
    {
        if (guid != default(Guid))
        {
            #if DEBUG
            VisitDto visit = new VisitDto() {Status = (new Random().Next(2) == 0 ? VisitStatusDto.VISIT_ACTIVE : VisitStatusDto.VISIT_PENDING)};
            #else
            VisitDto visit = await vs.ReadVisitByGuid(guid);
            #endif
            if (visit != null)
            {
                if (visit.Status == VisitStatusDto.VISIT_PENDING)
                {
                    #if DEBUG
                    form.FormData.ContactPerson = "Loaded from DB";
                    #else
                    form.FormData = await vs.ReadRegisterFormDataByGuid(guid);
                    #endif
                    carousel.MoveTo(HideFirstPage ? 0 : 1);
                }
                else if (visit.Status == VisitStatusDto.VISIT_ACTIVE)
                {
                    //await vs.UpdateVisit(visit.Id, visit.VisitStart, visit.VisitEnd, visit.Status, visit.ContactPerson, visit.CompanyLabel, visit.Visitor.FirstName, visit.Visitor.LastName, visit.Visitor.PhoneNumber, visit.Visitor.Email);
                    RenderFragment content =
                        @<div>@Loc["ConfirmSignOut"]</div>
                    ;
                    await Dialog.Show<MudDialog>(Loc["SignOut"], new DialogParameters() {["DialogContent"] = content}, new DialogOptions() {DisableBackdropClick = true, CloseButton = false}).Result;
                }
            }
            else
            {
                await Dialog.ShowMessageBox(Loc["InvalidQR"], null);
            }
        }
    }

    private async Task Register()
    {
        DateTime registeredAt = DateTime.Now;

        // Load data
        #if DEBUG
        Guid id = new("00000000-0000-0000-0000-000000000100");
        await Task.Delay(1000);
        #else
        Guid id = (await vs.AddVisit(registeredAt, form.FormData.FirstName, form.FormData.LastName, form.FormData.PhoneNumber, form.FormData.Email, form.FormData.Company, form.FormData.ContactPerson)).Guid;
        #endif

        // Generate qr code and pdf
        Bitmap qr = QRGenerator.GenerateQrCode(QRUrl + id.ToString());
        PdfDocument pdf = new TicketPdfGenerator(Loc.Culture).GetPdf(qr, id.ToString(), form.FormData.FullName, registeredAt);

        // Replace with print function
        pdf.Save("./pdf.pdf");

        // Reset form, scroll back to homepage and show popup
        form.Reset();
        carousel.MoveTo(0);
        #if DEBUG
        RenderFragment rf = 
            @<div>
                <img style="width: 100%" src="@($"data:image/png;base64,{Convert.ToBase64String(qr.ToBytes())}")"/>
                <a href=@(QRUrl + id.ToString())>Link</a>
            </div>
        ;
        await Dialog.Show<MudDialog>(Loc["RegisterSuccess"], new DialogParameters() {["DialogContent"] = rf}).Result;
        #else
        await Dialog.ShowMessageBox(Loc["RegisterSuccess"], null);
        #endif
    }

    private Bitmap BitmapFromUrl(string url)
    {
        HttpWebRequest request = WebRequest.CreateHttp(url);
        request.ServerCertificateValidationCallback += (sender, certificate, chain, sslPolicyErrors) => true;
        using (var response = request.GetResponse())
        {
            using (var stream = response.GetResponseStream())
            {
                return (Bitmap)Bitmap.FromStream(stream);
            }
        }
    }
}
