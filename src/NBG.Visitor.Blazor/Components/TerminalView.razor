@using MudBlazor;
@using NBG.Visitor.Blazor.Components.Dialogs
@using NBG.Visitor.Domain.Dtos;
@using NBG.Visitor.Domain;
@using System.Reflection
@using QRCoder
@using System.Drawing

@inject IDialogService Dialog;
@inject IVisitService vs;
@*@implements IMainLayout;*@

<link href="_content/NBG.Visitor.Blazor/css/site.css" rel="stylesheet"/>

<MudThemeProvider Theme="NBG"/>

@*<header>
    @header
</header>*@

@*<CascadingValue Value="this">*@
<CascadingValue Value="Loc">
    <MudCarousel Style="height: 100vh;" @ref="carousel" AutoCycle="false" ShowArrows="false" ShowDelimiters="false" TData="object">
        <MudCarouselItem>
            <TerminalHome OnNext=@(() => carousel.Next()) />
        </MudCarouselItem>
        <MudCarouselItem>
            <TerminalRegister @ref="form" OnBack=@(() => carousel.Previous()) OnNext=@(() => carousel.Next()) />
        </MudCarouselItem>
        <MudCarouselItem>
            <TerminalSafety OnBack=@(() => carousel.Previous()) OnRegister=Register/>
        </MudCarouselItem>
    </MudCarousel>
</CascadingValue>
@*</CascadingValue>*@

@*<footer>
    @footer
</footer>*@

@code {
    private Localizer Loc = new("NBG.Visitor.Blazor.Resources.TerminalLang", Assembly.GetExecutingAssembly(), "de-DE");

    //private RenderFragment header;
    private MudCarousel<object> carousel;
    //private RenderFragment footer;

    private TerminalRegister form;

    //public void SetHeader(RenderFragment header)
    //{
    //    this.header = header;
    //    StateHasChanged();
    //}

    //public void SetFooter(RenderFragment footer)
    //{
    //    this.footer = footer;
    //    StateHasChanged();
    //}

    MudTheme NBG = new MudTheme()
        {
            Palette = new Palette()
            {
                Primary = Colors.Red.Darken1,
                Secondary = Colors.Grey.Lighten2,
                SecondaryContrastText = Colors.Grey.Darken2
        }
    };

    private async void Register(RegisteredEventArgs e)
    {
        int id = await vs.AddVisit(DateTime.Now, form.FormData.ContactPerson, form.FormData.Company, form.FormData.FirstName, form.FormData.LastName, form.FormData.PhoneNumber, form.FormData.Email);

        QRCodeGenerator qrGenerator = new QRCodeGenerator();
        QRCodeData qrCodeData = qrGenerator.CreateQrCode(id.ToString(), QRCodeGenerator.ECCLevel.Q);
        QRCode qrCode = new QRCode(qrCodeData);
        Bitmap qr = qrCode.GetGraphic(20, System.Drawing.Color.Black, System.Drawing.Color.White, false/*, (Bitmap)Bitmap.FromFile("./_content/NBG.Visitor.Blazor/images/NBG_Icon_Red.png")*/); //TODO: find out why it can't find file
        RenderFragment rf = @<img style="width: 100%" src="@($"data:image/png;base64,{Convert.ToBase64String(qr.ToBytes())}")"/>;
        Dialog.Show<MudDialog>(e.Message, new DialogParameters() {["DialogContent"] = rf});

        form.Reset();
        carousel.MoveTo(0);
    }
}
